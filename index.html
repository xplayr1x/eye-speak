<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eye Blink Communicator</title>
  <link rel="stylesheet" href="style_Version3.css">
</head>
<body>

  <div id="yesno-bar">
    <button class="yesno-btn" id="yes-btn">YES</button>
    <button class="yesno-btn" id="no-btn">NO</button>
  </div>
  
  <div id="sentence-bar">
    <span id="sentence"></span>
    <button id="play-btn">Play</button>
  </div>

  <div id="word-grid"></div>

  <div id="instructions">
    <button id="hide-instructions">Hide Instructions</button>
    <p>Left eye Blink = play sentence</p>
    <p>Right eye close = stops sound</p>
    <p>Left eye close = delete last letter</p>
    <p>Right eye blink = select word</p>
    <p>both eyes long blink = space</p>
    <p>Touch = select word</p>
  </div>

  <video id="video" autoplay playsinline></video>
  <canvas id="output"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {

      // --- Main DOM Elements ---
      const video = document.getElementById('video');
      const canvas = document.getElementById('output');
      const ctx = canvas.getContext('2d');
      const letterGrid = document.getElementById('word-grid');
      const sentenceSpan = document.getElementById('sentence');
      const playBtn = document.getElementById('play-btn');
      const instructions = document.getElementById('instructions');
      const hideInstructionsBtn = document.getElementById('hide-instructions');
      const yesBtn = document.getElementById('yes-btn');
      const noBtn = document.getElementById('no-btn');
      
      // --- Canvas sizing ---
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      // --- Letters, Numbers + Special Keys (Each gets a big box) ---
      const lettersArray = [
        "YES", "NO", // Big-Button selections
        ..."ABCDEFGHIJKLMNOPQRSTUVWXYZ",
        ..."0123456789",
        "Space", "Delete"
      ];

      let letters = [];
      let activeIndex = 0;

      // --- Populate grid ---
      letterGrid.innerHTML = '';
      lettersArray.forEach((l, i) => {
        const div = document.createElement('div');
        div.className = 'letter';
        div.textContent = l;
        div.tabIndex = 0;
        div.addEventListener('click', () => selectLetter(i));
        letterGrid.appendChild(div);
        letters.push(div);
      });

      // --- YES/NO click support ---
      yesBtn.addEventListener('click', () => selectLetter(0));
      noBtn.addEventListener('click', () => selectLetter(1));

      // --- Highlight logic for YES/NO ---
      function setActiveLetter(index) {
        letters.forEach((l, i) => l.classList.toggle('active', i === index));
        yesBtn.classList.toggle('selected', index === 0);
        noBtn.classList.toggle('selected', index === 1);
        activeIndex = index;
        // Only scroll grid if not yes/no buttons
        if (index > 1 && letters[index]) letters[index].scrollIntoView({behavior: 'smooth', block: 'center', inline: 'center'});
      }

      // --- Smart word/letter selection (YES/NO works + space prevention) ---
      function selectLetter(index) {
        const value = letters[index].textContent;
        if (value === "YES" || value === "NO") {
          const w = value + " ";
          if (!sentenceSpan.textContent.endsWith(w)) sentenceSpan.textContent += w;
        } else if (value === "Space") {
          if (sentenceSpan.textContent.slice(-1) !== " " && sentenceSpan.textContent !== "") {
            sentenceSpan.textContent += " ";
          }
        } else if (value === "Delete") {
          sentenceSpan.textContent = sentenceSpan.textContent.slice(0, -1);
        } else {
          sentenceSpan.textContent += value;
        }
      }

      setActiveLetter(0);

      // --- Instructions panel drag & hide ---
      hideInstructionsBtn.addEventListener('click', () => instructions.style.display = 'none');
      instructions.onmousedown = function(e){
        let shiftX = e.clientX - instructions.getBoundingClientRect().left;
        let shiftY = e.clientY - instructions.getBoundingClientRect().top;
        function moveAt(pageX, pageY){ instructions.style.left = pageX - shiftX + 'px'; instructions.style.top = pageY - shiftY + 'px'; }
        function onMouseMove(e){ moveAt(e.pageX, e.pageY); }
        document.addEventListener('mousemove', onMouseMove);
        document.onmouseup = function(){ document.removeEventListener('mousemove', onMouseMove); document.onmouseup=null; }
      };
      instructions.ondragstart = () => false;

      // --- Speech playback ---
      function speakSentence() {
        if (sentenceSpan.textContent.trim().length === 0) return;
        const utter = new SpeechSynthesisUtterance(sentenceSpan.textContent.trim());
        utter.rate = 0.7;
        utter.pitch = 1;
        speechSynthesis.speak(utter);
      }
      playBtn.addEventListener('click', speakSentence);

      function stopSpeaking() {
        speechSynthesis.cancel();
      }

      // --- Ensure play button is always enabled ---
      function enablePlayBtn() {
        playBtn.disabled = false;
        playBtn.style.opacity = 1;
        playBtn.style.pointerEvents = 'auto';
      }
      enablePlayBtn();
      setInterval(enablePlayBtn, 500);

      // --- Eye Tracking with MediaPipe FaceMesh ---
      const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
      faceMesh.setOptions({ maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });

      let gazeDelay = 0;
      const EAR_THRESHOLD = 0.25;
      const BLINK_COOLDOWN = 400;
      const HOLD_DURATION = 1200;
      const LONG_BLINK_DURATION = 600;

      let framesClosed = 0, lastBlinkTime = 0, blinkStartTime = 0;
      let rightEyeHoldStart = 0, rightEyeHoldActive = false, rightEyeHoldDone = false;
      let leftEyeHoldStart = 0, leftEyeHoldActive = false, leftEyeHoldDone = false;

      faceMesh.onResults((results) => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(!results.multiFaceLandmarks[0]) return;
        const lm = results.multiFaceLandmarks[0];
        const now = Date.now();

        // --- Eye Ratio Calculation (EAR) ---
        const earL = Math.hypot(lm[159].x-lm[145].x, lm[159].y-lm[145].y) / Math.hypot(lm[33].x-lm[133].x, lm[33].y-lm[133].y);
        const earR = Math.hypot(lm[386].x-lm[374].x, lm[386].y-lm[374].y) / Math.hypot(lm[362].x-lm[263].x, lm[362].y-lm[263].y);

        // --- Right eye hold: stop sound (long), blink: select letter (short) ---
        if (earL < EAR_THRESHOLD && earR >= EAR_THRESHOLD) {
          if (!rightEyeHoldActive) {
            rightEyeHoldStart = now;
            rightEyeHoldActive = true;
            rightEyeHoldDone = false;
          }
          if (!rightEyeHoldDone && now - rightEyeHoldStart > HOLD_DURATION) {
            stopSpeaking();
            lastBlinkTime = now;
            rightEyeHoldDone = true;
          }
        } else if (rightEyeHoldActive) {
          if (!rightEyeHoldDone && now - rightEyeHoldStart > BLINK_COOLDOWN) {
            selectLetter(activeIndex);
            lastBlinkTime = now;
          }
          rightEyeHoldActive = false;
          rightEyeHoldDone = false;
          rightEyeHoldStart = 0;
        }

        // --- Left eye hold: delete last (long), blink: play sentence (short) ---
        if (earR < EAR_THRESHOLD && earL >= EAR_THRESHOLD) {
          if (!leftEyeHoldActive) {
            leftEyeHoldStart = now;
            leftEyeHoldActive = true;
            leftEyeHoldDone = false;
          }
          if (!leftEyeHoldDone && now - leftEyeHoldStart > HOLD_DURATION) {
            sentenceSpan.textContent = sentenceSpan.textContent.slice(0, -1);
            lastBlinkTime = now;
            leftEyeHoldDone = true;
          }
        } else if (leftEyeHoldActive) {
          if (!leftEyeHoldDone && now - leftEyeHoldStart > BLINK_COOLDOWN) {
            speakSentence();
            lastBlinkTime = now;
          }
          leftEyeHoldActive = false;
          leftEyeHoldDone = false;
          leftEyeHoldStart = 0;
        }

        // --- Both eyes closed (long blink) to add space and highlight box ---
        if (earL < EAR_THRESHOLD && earR < EAR_THRESHOLD) {
          framesClosed++;
          if (framesClosed === 1) blinkStartTime = now;
          if (now - blinkStartTime >= LONG_BLINK_DURATION && now - lastBlinkTime > BLINK_COOLDOWN) {
            const prevIndex = activeIndex;
            const spaceIndex = lettersArray.findIndex(x => x === "Space");
            if (spaceIndex > -1) {
              setActiveLetter(spaceIndex); // highlight
              selectLetter(spaceIndex);    // add space
              setTimeout(() => setActiveLetter(prevIndex), 350);
            }
            lastBlinkTime = now;
            framesClosed = 0;
            blinkStartTime = 0;
          }
        } else {
          framesClosed = 0;
          blinkStartTime = 0;
        }

        // --- Horizontal gaze movement: select previous/next letter ---
        const leftIris = lm[468], leftEyeInner = lm[133], leftEyeOuter = lm[33];
        const ratioX = (leftIris.x - leftEyeInner.x) / (leftEyeOuter.x - leftEyeInner.x);
        if(now - gazeDelay > 1000){ // less sensitive (1 sec interval)
          if(ratioX < 0.42) setActiveLetter((activeIndex-1 + letters.length) % letters.length);
          else if(ratioX > 0.58) setActiveLetter((activeIndex+1) % letters.length);
          gazeDelay = now;
        }
      });

      // --- Start camera ---
      const camera = new Camera(video, {
        onFrame: async () => { await faceMesh.send({image:video}); },
        width:640, height:480
      });
      camera.start();

    }); // End DOMContentLoaded
  </script>
</body>
</html>
